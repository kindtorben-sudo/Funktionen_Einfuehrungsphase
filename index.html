<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Funktionen-Master ‚Äì Lernspiel 11. Klasse BGT (optimiert)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #111827;
      --card: #1f2937;
      --accent: #3b82f6;
      --accent-soft: rgba(59,130,246,0.15);
      --accent-strong: #2563eb;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #f97373;
      --success: #4ade80;
      --border: #374151;
      --radius-lg: 1.25rem;
      --radius-xl: 1.75rem;
      --shadow-soft: 0 18px 45px rgba(0,0,0,0.45);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b, #020617 60%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 1.5rem;
    }

    .app {
      max-width: 1200px;
      width: 100%;
      background: linear-gradient(135deg, #020617 0%, #020617 40%, #0b1120 100%);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(148,163,184,0.25);
      box-shadow: var(--shadow-soft);
      padding: 1.75rem 2rem 2.25rem;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1.8rem;
    }

    .title-block h1 {
      font-size: 1.7rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: .6rem;
    }

    .title-pill {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: .12em;
      padding: .25rem .75rem;
      border-radius: 999px;
      background: var(--accent-soft);
      color: #bfdbfe;
      border: 1px solid rgba(59,130,246,0.5);
    }

    .subtitle {
      margin-top: .25rem;
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    .scoreboard {
      background: radial-gradient(circle at top, #1d283a, #020617 60%);
      border-radius: var(--radius-lg);
      padding: .75rem 1rem;
      border: 1px solid rgba(148,163,184,0.35);
      display: flex;
      gap: 1.25rem;
      align-items: center;
      min-width: 230px;
      justify-content: space-between;
    }

    .score-main {
      font-size: 1.2rem;
      font-weight: 600;
    }
    .score-main span { color: #fde68a; }
    .score-tag { font-size: 0.8rem; color: var(--text-soft); }

    .btn-reset {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: transparent;
      color: var(--text-soft);
      padding: .35rem .8rem;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: all .15s ease-out;
    }
    .btn-reset:hover {
      background: rgba(148,163,184,0.12);
      color: #e5e7eb;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
      margin-bottom: 1.25rem;
      border-bottom: 1px solid rgba(55,65,81,0.9);
      padding-bottom: .75rem;
    }

    .tab {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: .35rem .9rem;
      font-size: 0.85rem;
      cursor: pointer;
      background: transparent;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: background .15s, color .15s, border .15s;
    }

    .tab span.badge {
      font-size: 0.68rem;
      padding: .1rem .4rem;
      border-radius: 999px;
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,184,0.5);
      color: #cbd5f5;
    }

    .tab.active {
      background: var(--accent-soft);
      color: #eff6ff;
      border-color: rgba(59,130,246,0.75);
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.3fr);
      gap: 1.5rem;
    }

    @media (max-width: 900px) {
      main { grid-template-columns: minmax(0, 1fr); }
    }

    .card {
      background: radial-gradient(circle at top left, #111827, #020617 65%);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(75,85,99,0.9);
      padding: 1.25rem 1.4rem 1.35rem;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(56,189,248,0.12), transparent 55%);
      opacity: 0.6;
      pointer-events: none;
    }

    .card > * {
      position: relative;
      z-index: 1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      align-items: baseline;
      margin-bottom: 0.75rem;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    .card-title small {
      font-size: 0.8rem;
      font-weight: 400;
      color: var(--text-soft);
    }

    .pill {
      font-size: 0.7rem;
      padding: .15rem .55rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      color: #c7d2fe;
      background: rgba(15,23,42,0.7);
      text-transform: uppercase;
      letter-spacing: .09em;
    }

    .card-body {
      font-size: 0.9rem;
      color: var(--text-soft);
      display: grid;
      gap: .9rem;
    }

    .info { font-size: 0.85rem; }

    .task {
      padding: .65rem .75rem;
      border-radius: .9rem;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.9);
      display: grid;
      gap: .4rem;
    }

    .task strong { color: #e5e7eb; }

    label {
      font-size: 0.82rem;
      color: var(--text-soft);
      display: block;
      margin-bottom: 0.15rem;
    }

    select,
    input[type="number"],
    input[type="range"],
    input[type="text"] {
      width: 100%;
      padding: .45rem .6rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(75,85,99,0.9);
      background: #020617;
      color: var(--text);
      font-size: 0.85rem;
      outline: none;
      transition: border .15s, box-shadow .15s;
    }

    input[type="range"] {
      padding: 0;
      background: transparent;
    }

    select:focus,
    input[type="number"]:focus,
    input[type="text"]:focus {
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px rgba(59,130,246,0.75);
    }

    .input-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: .5rem;
    }

    @media (max-width: 700px) {
      .input-row { grid-template-columns: minmax(0, 1fr); }
    }

    .btn {
      border-radius: .7rem;
      border: none;
      padding: .45rem .9rem;
      font-size: 0.85rem;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      margin-top: 0.25rem;
      transition: transform .08s ease-out, box-shadow .08s ease-out;
      box-shadow: 0 10px 25px rgba(37,99,235,0.35);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(37,99,235,0.45);
    }

    .btn.secondary {
      background: transparent;
      border: 1px solid rgba(148,163,184,0.7);
      box-shadow: none;
      color: var(--text-soft);
    }

    .btn.secondary:hover {
      background: rgba(148,163,184,0.12);
      color: #e5e7eb;
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
      margin-top: .25rem;
    }

    .result {
      font-size: 0.85rem;
      margin-top: 0.25rem;
      min-height: 1.2em;
      white-space: pre-line;
    }
    .result.ok { color: var(--success); }
    .result.bad { color: var(--danger); }
    .result.info { color: var(--text-soft); }

    .tag-points { font-size: 0.75rem; color: #a5b4fc; }

    .function-display {
      padding: .55rem .7rem;
      border-radius: .7rem;
      background: rgba(15,23,42,0.9);
      border: 1px dashed rgba(75,85,99,0.9);
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 0.86rem;
      color: #e5e7eb;
    }

    .function-display span.label {
      color: var(--text-soft);
      font-weight: 500;
      margin-right: .4rem;
    }

    .fx-grid { display: grid; gap: .6rem; }

    .fx-row {
      display: flex;
      justify-content: space-between;
      gap: .75rem;
      flex-wrap: wrap;
      font-size: 0.82rem;
    }

    .fx-row span.key { color: var(--text-soft); }
    .fx-row span.val { color: #e5e7eb; font-weight: 500; }

    .badge-soft {
      font-size: 0.75rem;
      border-radius: 999px;
      padding: .1rem .5rem;
      background: rgba(55,85,81,0.9);
      color: #cbd5f5;
      border: 1px solid rgba(75,85,99,0.9);
    }

    .small-text { font-size: 0.75rem; color: var(--text-soft); }

    canvas {
      width: 100%;
      max-width: 520px;
      border-radius: .9rem;
      border: 1px solid rgba(75,85,99,0.9);
      background: radial-gradient(circle at top, #020617, #020617 60%);
      display: block;
    }

    .slider-row {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.8fr);
      gap: .4rem;
      align-items: center;
    }

    /* Layout & Infobox nur f√ºr Level 4 */
    .level4-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.2fr);
      gap: 1rem;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .level4-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .infobox {
      background: rgba(15,23,42,0.95);
      border-radius: .9rem;
      border: 1px solid rgba(75,85,99,0.9);
      padding: .7rem .8rem;
      font-size: 0.8rem;
    }

    .infobox h4 {
      margin: 0 0 .4rem;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .infobox p {
      margin: .25rem 0;
    }

    .infobox ul {
      margin: .25rem 0 .4rem;
      padding-left: 1.2rem;
    }

  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title-block">
      <div class="title-pill">11. Klasse BGT ¬∑ Potenz- & Wurzelfunktionen</div>
      <h1>Funktionen-Master <span style="font-size:1.3rem;">üéÆ</span></h1>
      <div class="subtitle">
        Lernspiel zu Funktionsarten, Verschiebungen, Achsenschnittpunkten sowie
        Definitions- und Wertemengen (Potenzfunktionen mit positiven/negativen Exponenten & Wurzelfunktionen).
      </div>
    </div>

    <div class="scoreboard" aria-label="Punktestand">
      <div>
        <div class="score-main">Punkte: <span id="totalScore">0</span></div>
        <div class="score-tag">Sammle Punkte in den Leveln 1‚Äì4.</div>
      </div>
      <button class="btn-reset" id="resetScoreBtn" type="button">
        ‚Ü∫ Punkte zur√ºcksetzen
      </button>
    </div>
  </header>

  <nav class="tabs" aria-label="Lernspiel-Abschnitte">
    <button class="tab active" data-tab="level1">
      Level 1
      <span class="badge">Funktionsarten</span>
    </button>
    <button class="tab" data-tab="level2">
      Level 2
      <span class="badge">Verschiebungen</span>
    </button>
    <button class="tab" data-tab="level3">
      Level 3
      <span class="badge">Achsenschnittpunkte</span>
    </button>
    <button class="tab" data-tab="level4">
      Level 4
      <span class="badge">D & W</span>
    </button>
    <button class="tab" data-tab="graph">
      Graphen
      <span class="badge">interaktiv</span>
    </button>
  </nav>

  <main>
    <!-- LEFT COLUMN: Level content -->
    <section id="levelContent">

      <!-- LEVEL 1 -->
      <div class="card level-panel" id="panel-level1">
        <div class="card-header">
          <div class="card-title">
            Level 1: Funktionsarten erkennen
            <small>(max. 5 Punkte)</small>
          </div>
          <span class="pill">Zuordnung</span>
        </div>
        <div class="card-body">
          <p class="info">
            Ordne jeder Funktionsgleichung den passenden Typ zu. Fokus: lineare Funktionen,
            Potenzfunktionen mit <strong>positivem</strong> und <strong>negativem Exponenten</strong> sowie <strong>Wurzelfunktionen</strong>
            (als Potenz mit Bruch-Exponent, z.B. x^(1/2)).
          </p>

          <div class="task">
            <strong>Aufgabe</strong>
            <div class="small-text">
              W√§hle f√ºr jede Funktion den Typ:
              <em>Lineare Funktion, Potenzfunktion (positiver Exponent), Potenzfunktion (negativer Exponent), Wurzelfunktion</em>.
            </div>

            <div id="level1-rows"></div>

            <div class="btn-group">
              <button class="btn" id="checkLevel1Btn" type="button">
                ‚úÖ Antworten pr√ºfen
              </button>
              <button class="btn secondary" id="randomLevel1Btn" type="button">
                üé≤ Neue Funktionen
              </button>
            </div>

            <div class="result" id="level1Result"></div>
            <div class="tag-points">Richtige Zuordnung: je 1 Punkt</div>
          </div>
        </div>
      </div>

      <!-- LEVEL 2 -->
      <div class="card level-panel" id="panel-level2" style="display:none;">
        <div class="card-header">
          <div class="card-title">
            Level 2: Verschiebungs-Detektiv (Parabeln, Wurzel & Potenz)
            <small>(max. 4 Punkte)</small>
          </div>
          <span class="pill">Transformationen</span>
        </div>
        <div class="card-body">
          <p class="info">
            Wir betrachten eine Basisfunktion und vier verschobene bzw. gespiegelte Varianten
            (Parabel, Wurzel, positive oder negative Potenzfunktion).
          </p>
          <div class="function-display" id="l2FunctionsDisplay">
            <span class="label">A:</span> f(x) = x¬≤<br/>
            <span class="label">B:</span> g(x) = (x ‚àí 3)¬≤<br/>
            <span class="label">C:</span> h(x) = x¬≤ + 4<br/>
            <span class="label">D:</span> k(x) = (x + 1)¬≤ ‚àí 2<br/>
            <span class="label">E:</span> m(x) = ‚àíx¬≤ + 2
          </div>

          <div class="task">
            <strong>Aufgabe</strong>
            <div class="small-text">
              W√§hle jeweils den passenden Buchstaben (A‚ÄìE).
            </div>

            <div class="input-row">
              <div>
                <label>1. Nach rechts verschoben:</label>
                <input type="text" id="l2q1" maxlength="1" placeholder="Buchstabe (A‚ÄìE)" />
              </div>
              <div>
                <label>2. Nach links und nach unten verschoben:</label>
                <input type="text" id="l2q2" maxlength="1" placeholder="Buchstabe (A‚ÄìE)" />
              </div>
              <div>
                <label>3. Nur nach oben verschoben:</label>
                <input type="text" id="l2q3" maxlength="1" placeholder="Buchstabe (A‚ÄìE)" />
              </div>
            </div>

            <div class="input-row" style="margin-top:.4rem;">
              <div>
                <label>4. Spiegelung an der x-Achse (nach unten ge√∂ffnet/gedreht):</label>
                <input type="text" id="l2q4" maxlength="1" placeholder="Buchstabe (A‚ÄìE)" />
              </div>
            </div>

            <div class="btn-group">
              <button class="btn" id="checkLevel2Btn" type="button">
                ‚úÖ Antworten pr√ºfen
              </button>
              <button class="btn secondary" id="randomLevel2Btn" type="button">
                üé≤ Neue Funktionen
              </button>
            </div>
            <div class="result" id="level2Result"></div>
            <div class="tag-points">Jede richtige Zuordnung: 1 Punkt</div>
          </div>
        </div>
      </div>

      <!-- LEVEL 3 -->
      <div class="card level-panel" id="panel-level3" style="display:none;">
        <div class="card-header">
          <div class="card-title">
            Level 3: Achsenschnittpunkte
            <small>(max. 6 Punkte)</small>
          </div>
          <span class="pill">Schnittpunkte</span>
        </div>
        <div class="card-body">
          <p class="info">
            Berechne die Schnittpunkte mit der x- und y-Achse f√ºr die beiden Funktionen.
            Gib die Koordinaten als Dezimalzahlen an (Toleranz wird ber√ºcksichtigt).
          </p>

          <div class="task">
            <strong>Funktion 1 (Parabel):</strong>
            <div class="function-display" id="l3Function1Display">
              f(x) = x¬≤ ‚àí 4
            </div>
            <div class="input-row">
              <div>
                <label>y-Achse: f(0) =</label>
                <input type="number" step="0.01" id="l3f1_y" placeholder="-4" />
              </div>
              <div>
                <label>x-Schnittpunkt 1:</label>
                <input type="number" step="0.01" id="l3f1_x1" placeholder="-2" />
              </div>
              <div>
                <label>x-Schnittpunkt 2:</label>
                <input type="number" step="0.01" id="l3f1_x2" placeholder="2" />
              </div>
            </div>
            <div class="tag-points">Alle drei richtig: 3 Punkte</div>
          </div>

          <div class="task">
            <strong>Funktion 2 (linear / Wurzel / Potenz / 1/x):</strong>
            <div class="function-display" id="l3Function2Display">
              g(x) = 2x ‚àí 3
            </div>
            <div class="input-row">
              <div>
                <label>y-Achse: g(0) =</label>
                <input type="number" step="0.01" id="l3f2_y" placeholder="-3" />
              </div>
              <div>
                <label>x-Schnittpunkt:</label>
                <input type="number" step="0.01" id="l3f2_x" placeholder="1.5" />
              </div>
            </div>
            <div class="tag-points">Beide richtig: 3 Punkte</div>

            <div class="btn-group">
              <button class="btn" id="checkLevel3Btn" type="button">
                ‚úÖ Antworten pr√ºfen
              </button>
              <button class="btn secondary" id="randomLevel3Btn" type="button">
                üé≤ Neue Funktionen
              </button>
            </div>
            <div class="result" id="level3Result"></div>
          </div>
        </div>
      </div>

      <!-- LEVEL 4 -->
      <div class="card level-panel" id="panel-level4" style="display:none;">
        <div class="card-header">
          <div class="card-title">
            Level 4: Definitions- & Wertebereich
            <small>(max. 5 Punkte)</small>
          </div>
          <span class="pill">D & W</span>
        </div>
        <div class="card-body">
          <div class="level4-layout">
            <!-- linke Spalte: Aufgabe -->
            <div>
              <p class="info">
                W√§hle f√ºr die angezeigte Funktion den passenden Definitions- und Wertebereich.
              </p>

              <div class="task">
                <strong>Aufgabe</strong>
                <div class="small-text">
                  Klicke auf ‚ÄûNeue Funktion‚Äú, w√§hle dann Definitionsmenge und Wertebereich.
                </div>

                <div class="function-display" id="l4FunctionDisplay">
                  Noch keine Funktion ausgew√§hlt.
                </div>

                <div class="input-row" style="margin-top:.5rem;">
                  <div>
                    <label>Definitionsmenge</label>
                    <!-- Optionen werden jetzt per JS je Funktion gesetzt -->
                    <select id="l4DomainSelect">
                      <option value="">‚Äì bitte w√§hlen ‚Äì</option>
                    </select>
                  </div>
                  <div>
                    <label>Wertemenge</label>
                    <!-- Optionen werden jetzt per JS je Funktion gesetzt -->
                    <select id="l4RangeSelect">
                      <option value="">‚Äì bitte w√§hlen ‚Äì</option>
                    </select>
                  </div>
                </div>

                <div class="btn-group">
                  <button class="btn secondary" id="newL4FunctionBtn" type="button">
                    üé≤ Neue Funktion
                  </button>
                  <button class="btn" id="checkLevel4Btn" type="button">
                    ‚úÖ Antworten pr√ºfen
                  </button>
                </div>

                <div class="result" id="level4Result"></div>
                <div class="tag-points">Pro korrektes Paar (D & W): 1 Punkt, max. 5 Punkte</div>
              </div>
            </div>

            <!-- rechte Spalte: Infobox zu Werte- und Definitionsbereich -->
            <div class="infobox">
              <h4>Wertebereich bestimmen ‚Äì √úberblick</h4>

              <p>üéØ <strong>1. Lineare Funktionen</strong><br>
                Wertebereich: <strong>W = ‚Ñù</strong><br>
                Beispiele: f(x) = 3x ‚àí 0,5; f(x) = 7 ‚àí 5x.<br>
                F√ºr x ‚Üí ‚àû bzw. x ‚Üí ‚àí‚àû w√§chst/f√§llt die Gerade ohne Grenze ‚Üí alle y-Werte kommen vor.
              </p>

              <p>üéØ <strong>2. Quadratische Funktionen</strong><br>
                Wertebereich = ‚ÄûExtremwert + Unendlich‚Äú.<br>
                Beispiele: f(x) = 2,5 ‚àí x¬≤; f(x) = (x + 1)(x ‚àí 2); f(z) = z¬≤ ‚àí 2z.<br>
                Rechnerischer Weg:
                <br>1. Scheitel berechnen: x<sub>S</sub> = ‚àíb / (2a)
                <br>2. f(x<sub>S</sub>) einsetzen
                <br>3. Vorzeichen von a:
                <br>‚Ä¢ a &gt; 0: W = [ f(x<sub>S</sub>), ‚àû )
                <br>‚Ä¢ a &lt; 0: W = ( ‚àí‚àû , f(x<sub>S</sub>) ]
              </p>

              <p>üéØ <strong>3. Wurzelfunktionen</strong><br>
                Wertebereich √ºber eine Ungleichung berechnen.<br>
                Beispiel: f(x) = ‚àö(x + 2) ‚àí 1.
                <br>1. Radikand ‚â• 0: x + 2 ‚â• 0 ‚áí x ‚â• ‚àí2
                <br>2. Wertebereich: ‚àö(x + 2) ‚â• 0 ‚áí ‚àö(x + 2) ‚àí 1 ‚â• ‚àí1
                <br>‚áí W = [ ‚àí1 , ‚àû )
              </p>

              <p>üéØ <strong>4. Bruchfunktionen</strong><br>
                Wertebereich durch Umformen bestimmen.<br>
                Beispiel: f(z) = 1 + 1/z.
                <br>Setze y = 1 + 1/z ‚áí y ‚àí 1 = 1/z.
                <br>Die rechte Seite kann nie 0 sein ‚áí y ‚àí 1 ‚â† 0 ‚áí y ‚â† 1.
                <br>‚áí W = ‚Ñù \\ {1}.
              </p>

              <p><strong>üß† Zusammenfassung ‚Äì Wertebereich</strong><br>
                1. Polynom (linear, quadratisch, h√∂here Grade):<br>
                ‚Ä¢ linear: W = ‚Ñù<br>
                ‚Ä¢ quadratisch: Scheitel berechnen<br>
                ‚Ä¢ h√∂here Grade: Grenzwerte f√ºr x ‚Üí ¬±‚àû pr√ºfen<br><br>
                2. Wurzelfunktion: Radikand ‚â• 0 und Ungleichung auswerten.<br>
                3. Bruchfunktion: Nenner ‚â† 0 und ggf. y-Werte suchen, die nicht erreicht werden.<br>
                4. Logarithmusfunktion: Argument &gt; 0, Wertebereich meist ‚Ñù.
              </p>

              <p><strong>üìå Definitionsbereich ‚Äì kurz erkl√§rt</strong><br>
                ‚Ä¢ Polynome (lineare, quadratische, h√∂here Grade): D = ‚Ñù (x darf alles sein).<br>
                ‚Ä¢ Wurzelfunktion mit geradem Wurzelexponenten: Ausdruck unter der Wurzel ‚â• 0 setzen und nach x l√∂sen.<br>
                ‚Ä¢ Bruchfunktion: Alle x, f√ºr die der Nenner 0 wird, aus ‚Ñù herausnehmen.<br>
                ‚Ä¢ Logarithmusfunktion: Argument &gt; 0 setzen und Ungleichung nach x l√∂sen.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- GRAPH TAB -->
      <div class="card level-panel" id="panel-graph" style="display:none;">
        <div class="card-header">
          <div class="card-title">
            Graphische Darstellung (interaktiv)
          </div>
          <span class="pill">Canvas</span>
        </div>
        <div class="card-body">
          <p class="info">
            W√§hle eine Funktionsfamilie und ver√§ndere die Parameter. Der Graph aktualisiert sich sofort.
            Koordinatensystem: ca. x,y ‚àà [‚àí10; 10]. Wurzelfunktionen werden als Potenzen mit Exponent 1/2 gezeichnet.
            Bei negativen Potenzen wird die Asymptote und die ‚ÄûL√ºcke‚Äú (fehlender Punkt) markiert.
          </p>

          <div class="task">
            <strong>1. Funktionsfamilie w√§hlen</strong>
            <label for="graphFunctionSelect" style="margin-top:.25rem;">Funktionsfamilie:</label>
            <select id="graphFunctionSelect">
              <option value="linear">Lineare Funktion: f(x) = m¬∑x + b</option>
              <option value="pos">Potenzfunktion (positiver Exponent): f(x) = a¬∑(x ‚àí h)‚Åø + k</option>
              <option value="neg">Potenzfunktion (negativer Exponent): f(x) = a / (x ‚àí h)‚Åø + k</option>
              <option value="root">Wurzelfunktion: f(x) = a¬∑(x ‚àí h)^(1/2) + k</option>
            </select>

            <div id="graphFormula" class="small-text" style="margin-top:.5rem;"></div>
          </div>

          <div class="task">
            <strong>2. Parameter einstellen</strong>
            <div id="graphControls"></div>
          </div>

          <div class="task">
            <strong>3. Graph</strong>
            <canvas id="graphCanvas" width="520" height="360"></canvas>
            <div class="small-text">
              Tipp: Variiere h (horizontale Verschiebung) und k (vertikale Verschiebung) und beobachte,
              wie sich der Graph verschiebt. Bei negativen Potenzen werden die Asymptoten x = h und y = k
              gestrichelt gezeichnet und der fehlende Punkt (h, k) als offener Kreis markiert.
            </div>
          </div>
        </div>
      </div>

    </section>

    <!-- RIGHT COLUMN: Hints & summary -->
    <aside>
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            Spickzettel: Potenz- & Wurzelfunktionen
          </div>
          <span class="pill">Theorie</span>
        </div>
        <div class="card-body">
          <div class="fx-grid">
            <div class="fx-row">
              <span class="key">Lineare Funktion</span>
              <span class="val">f(x) = m¬∑x + b</span>
            </div>
            <div class="fx-row">
              <span class="key">Potenz, positiver Exponent</span>
              <span class="val">f(x) = a¬∑x‚Åø, z.B. x¬≤, x¬≥, x‚Å¥, ‚Ä¶</span>
            </div>
            <div class="fx-row">
              <span class="key">Potenz, negativer Exponent</span>
              <span class="val">f(x) = a¬∑x‚Åø mit n &lt; 0, z.B. 1/x, 1/x¬≥</span>
            </div>
            <div class="fx-row">
              <span class="key">Wurzelfunktion</span>
              <span class="val">f(x) = a¬∑x^(1/2)</span>
            </div>
          </div>

          <hr style="border-color:rgba(55,65,81,0.9);margin:0.9rem 0;">

          <div class="small-text">
            <span class="badge-soft">Verschiebung in x-Richtung</span><br/>
            (x ‚àí h) ‚Üí nach rechts, (x + h) ‚Üí nach links.
          </div>

          <div class="small-text" style="margin-top:.6rem;">
            <span class="badge-soft">Verschiebung in y-Richtung</span><br/>
            +k ‚Üí nach oben, ‚àík ‚Üí nach unten.
          </div>

          <div class="small-text" style="margin-top:.6rem;">
            <span class="badge-soft">Spiegelung</span><br/>
            Vorzeichenwechsel bei a (z.B. a &lt; 0) spiegelt an der x-Achse.
          </div>

          <div class="small-text" style="margin-top:.7rem;">
            <strong>Tipp:</strong> Nutzt den Graphen-Tab, um eure Rechnungen aus den Leveln zu √ºberpr√ºfen.
          </div>
        </div>
      </div>
    </aside>
  </main>
</div>

<script>
  // ---- Global score handling ----
  let score = 0;

  function updateScore(delta) {
    score += delta;
    if (score < 0) score = 0;
    document.getElementById("totalScore").textContent = score;
  }

  document.getElementById("resetScoreBtn").addEventListener("click", () => {
    score = 0;
    document.getElementById("totalScore").textContent = score;
  });

  // ---- Tab navigation ----
  const tabs = document.querySelectorAll(".tab");
  const panels = document.querySelectorAll(".level-panel");

  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      const id = tab.getAttribute("data-tab");

      tabs.forEach(t => t.classList.remove("active"));
      tab.classList.add("active");

      panels.forEach(p => {
        if (p.id === "panel-" + id) {
          p.style.display = "";
        } else {
          p.style.display = "none";
        }
      });
    });
  });

  // Hilfsfunktionen f√ºr Zufall
  function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function randChoice(arr) {
    return arr[randInt(0, arr.length - 1)];
  }

  // ---- LEVEL 1: Funktionsarten ----
  const level1Functions = [
    { expr: "f(x) = 2x ‚àí 3", solution: "linear" },
    { expr: "g(x) = x¬≤ ‚àí 4", solution: "pos" },
    { expr: "h(x) = x‚Å¥", solution: "pos" },
    { expr: "p(x) = 1/x", solution: "neg" },
    { expr: "q(x) = x^(1/2)", solution: "root" }
  ];

  const typeOptions = [
    { value: "linear", label: "Lineare Funktion" },
    { value: "pos", label: "Potenzfunktion (positiver Exponent)" },
    { value: "neg", label: "Potenzfunktion (negativer Exponent)" },
    { value: "root", label: "Wurzelfunktion" }
  ];

  const level1Container = document.getElementById("level1-rows");
  const level1Labels = [];

  level1Functions.forEach((fn, idx) => {
    const row = document.createElement("div");
    row.style.display = "grid";
    row.style.gridTemplateColumns = "minmax(0,1.2fr) minmax(0,2fr)";
    row.style.gap = ".6rem";
    row.style.alignItems = "center";
    row.style.marginTop = ".45rem";

    const label = document.createElement("div");
    label.textContent = fn.expr;
    level1Labels.push(label);

    const select = document.createElement("select");
    select.id = "l1-select-" + idx;
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "‚Äì Funktionsart w√§hlen ‚Äì";
    select.appendChild(placeholder);

    typeOptions.forEach(opt => {
      const o = document.createElement("option");
      o.value = opt.value;
      o.textContent = opt.label;
      select.appendChild(o);
    });

    row.appendChild(label);
    row.appendChild(select);
    level1Container.appendChild(row);
  });

  function randomizeLevel1() {
    // Slot 0: linear
    const m = randChoice([-4,-3,-2,-1,1,2,3,4]);
    const b = randInt(-5,5);
    const signB = b > 0 ? " + " + b : (b < 0 ? " ‚àí " + (-b) : "");
    level1Functions[0].expr = "f(x) = " + m + "x" + (b !== 0 ? signB : "");
    level1Functions[0].solution = "linear";

    // Slot 1 & 2: positive Potenzfunktionen (Exponenten bis 8)
    for (let i = 1; i <= 2; i++) {
      const a = randChoice([-2,-1,1,2]);
      const n = randInt(2,8);
      const signA = (a === 1) ? "" : (a === -1 ? "-" : a);
      const name = (i === 1 ? "g" : "h");
      level1Functions[i].expr = name + "(x) = " +
        (signA ? signA : "") +
        "x^" + n;
      level1Functions[i].solution = "pos";
    }

    // Slot 3: negative Potenz (1/x^n)
    const aNeg = randChoice([-3,-2,-1,1,2,3]);
    const nNeg = randInt(1,8);
    level1Functions[3].expr = "p(x) = " + aNeg + "/x^" + nNeg;
    level1Functions[3].solution = "neg";

    // Slot 4: Wurzel als Bruchpotenz (x - c)^(1/2)
    const c = randChoice([-4,-2,0,2,4]);
    const signC = c > 0 ? " + " + c : (c < 0 ? " ‚àí " + (-c) : "");
    level1Functions[4].expr = "q(x) = (x" + (c !== 0 ? signC : "") + ")^(1/2)";
    level1Functions[4].solution = "root";

    // DOM aktualisieren & Auswahl l√∂schen
    level1Functions.forEach((fn, idx) => {
      level1Labels[idx].textContent = fn.expr;
      const sel = document.getElementById("l1-select-" + idx);
      if (sel) sel.value = "";
    });
    document.getElementById("level1Result").textContent = "";
  }

  document.getElementById("randomLevel1Btn").addEventListener("click", randomizeLevel1);

  document.getElementById("checkLevel1Btn").addEventListener("click", () => {
    let correct = 0;

    level1Functions.forEach((fn, idx) => {
      const select = document.getElementById("l1-select-" + idx);
      if (select.value === fn.solution) {
        correct++;
      }
    });

    const resultEl = document.getElementById("level1Result");
    resultEl.className = "result";
    const gained = correct; // 1 Punkt pro richtiger Zuordnung
    updateScore(gained);
    resultEl.classList.add(correct === level1Functions.length ? "ok" : "info");
    resultEl.textContent =
      `Du hast ${correct} von ${level1Functions.length} richtig. +${gained} Punkte`;
  });

  // ---- LEVEL 2: Verschiebungen ----
  const level2Solution = {
    q1: "B", // rechtsverschoben
    q2: "D", // links & unten
    q3: "C", // oben
    q4: "E"  // Spiegelung
  };

  function normalizeLetter(str) {
    return (str || "").trim().toUpperCase();
  }

  function randomizeLevel2() {
    const family = randChoice(["quad","root","pos","neg"]);

    const r = randInt(1,5);   // rechts
    const u = randInt(1,5);   // nach oben
    const l = randInt(1,5);   // links
    const v = randInt(1,5);   // nach unten
    const w = randInt(-3,3);  // vertikale Verschiebung beim gespiegelten

    let html = "";

    if (family === "quad") {
      const signU = " + " + u;
      const signV = " ‚àí " + v;
      const signW = w > 0 ? " + " + w : (w < 0 ? " ‚àí " + (-w) : "");
      html =
        `<span class="label">A:</span> f(x) = x¬≤<br/>` +
        `<span class="label">B:</span> g(x) = (x ‚àí ${r})¬≤<br/>` +
        `<span class="label">C:</span> h(x) = x¬≤${signU}<br/>` +
        `<span class="label">D:</span> k(x) = (x + ${l})¬≤${signV}<br/>` +
        `<span class="label">E:</span> m(x) = ‚àíx¬≤${signW}`;
    } else if (family === "root") {
      const signU = " + " + u;
      const signV = " ‚àí " + v;
      const signW = w > 0 ? " + " + w : (w < 0 ? " ‚àí " + (-w) : "");
      html =
        `<span class="label">A:</span> f(x) = x^(1/2)<br/>` +
        `<span class="label">B:</span> g(x) = (x ‚àí ${r})^(1/2)<br/>` +
        `<span class="label">C:</span> h(x) = x^(1/2)${signU}<br/>` +
        `<span class="label">D:</span> k(x) = (x + ${l})^(1/2)${signV}<br/>` +
        `<span class="label">E:</span> m(x) = ‚àíx^(1/2)${signW}`;
    } else if (family === "pos") {
      const n = randInt(2,8);
      const signU = " + " + u;
      const signV = " ‚àí " + v;
      const signW = w > 0 ? " + " + w : (w < 0 ? " ‚àí " + (-w) : "");
      html =
        `<span class="label">A:</span> f(x) = x^${n}<br/>` +
        `<span class="label">B:</span> g(x) = (x ‚àí ${r})^${n}<br/>` +
        `<span class="label">C:</span> h(x) = x^${n}${signU}<br/>` +
        `<span class="label">D:</span> k(x) = (x + ${l})^${n}${signV}<br/>` +
        `<span class="label">E:</span> m(x) = ‚àíx^${n}${signW}`;
    } else { // "neg"
      const n = randInt(1,8);
      const signW = w > 0 ? " + " + w : (w < 0 ? " ‚àí " + (-w) : "");
      const signU = " + " + u;
      const signV = " ‚àí " + v;
      html =
        `<span class="label">A:</span> f(x) = 1/x^${n}<br/>` +
        `<span class="label">B:</span> g(x) = 1/(x ‚àí ${r})^${n}<br/>` +
        `<span class="label">C:</span> h(x) = 1/x^${n}${signU}<br/>` +
        `<span class="label">D:</span> k(x) = 1/(x + ${l})^${n}${signV}<br/>` +
        `<span class="label">E:</span> m(x) = ‚àí1/x^${n}${signW}`;
    }

    document.getElementById("l2FunctionsDisplay").innerHTML = html;

    // Eingaben & Ergebnis leeren
    ["l2q1","l2q2","l2q3","l2q4"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });
    document.getElementById("level2Result").textContent = "";
  }

  document.getElementById("randomLevel2Btn").addEventListener("click", randomizeLevel2);

  document.getElementById("checkLevel2Btn").addEventListener("click", () => {
    const answers = {
      q1: normalizeLetter(document.getElementById("l2q1").value),
      q2: normalizeLetter(document.getElementById("l2q2").value),
      q3: normalizeLetter(document.getElementById("l2q3").value),
      q4: normalizeLetter(document.getElementById("l2q4").value)
    };

    let correct = 0;
    Object.keys(level2Solution).forEach(k => {
      if (answers[k] === level2Solution[k]) correct++;
    });

    const resultEl = document.getElementById("level2Result");
    resultEl.className = "result";
    const gained = correct; // 1 Punkt pro richtig
    updateScore(gained);

    if (correct === 4) {
      resultEl.classList.add("ok");
      resultEl.textContent = `Perfekt! Alle 4 Zuordnungen sind richtig. +${gained} Punkte`;
    } else {
      resultEl.classList.add(correct > 0 ? "info" : "bad");
      resultEl.textContent =
        `Du hast ${correct} von 4 richtig. (+${gained} Punkte) Tipp: Pr√ºfe, wie sich der Scheitelpunkt bzw. Startpunkt der Funktion verschiebt.`;
    }
  });

  // ---- LEVEL 3: Achsenschnittpunkte ----
  function near(a, b, tol = 0.05) {
    if (isNaN(a) || isNaN(b)) return false;
    return Math.abs(a - b) <= tol;
  }

  let level3Data = {
    f1: { y0: -4, x1: -2, x2: 2 },
    f2: { y0: -3, x: 1.5 }
  };

  function randomizeLevel3() {
    // Funktion 1: Parabel mit zwei ganzzahligen Nullstellen r1<0, r2>0
    const r1 = randChoice([-4,-3,-2,-1]);
    const r2 = randChoice([1,2,3,4]);
    const c = r1 * r2;
    const s = r1 + r2;
    const signS = s > 0 ? " ‚àí " + s + "x" : (s < 0 ? " + " + (-s) + "x" : "");
    const signC = c > 0 ? " + " + c : (c < 0 ? " ‚àí " + (-c) : "");
    const f1Expr = "f(x) = x¬≤" + signS + signC;
    document.getElementById("l3Function1Display").textContent = f1Expr;
    level3Data.f1 = { y0: c, x1: r1, x2: r2 };

    // Funktion 2: zuf√§llig linear / Wurzel / Potenz / 1/x
    const type = randChoice(["linear","root","pos","neg"]);
    let f2Expr, y0, x0;

    if (type === "linear") {
      const m = randChoice([-4,-3,-2,-1,1,2,3,4]);
      const xNull = randChoice([-4,-3,-2,-1,1,2,3,4]);
      const c2 = -m * xNull;
      const signC2 = c2 > 0 ? " + " + c2 : (c2 < 0 ? " ‚àí " + (-c2) : "");
      f2Expr = "g(x) = " + m + "x" + (c2 !== 0 ? signC2 : "");
      y0 = c2;
      x0 = xNull;
    } else if (type === "root") {
      const cRoot = randChoice([0,1,4,9]);
      const sign = cRoot > 0 ? " + " + cRoot : "";
      f2Expr = "g(x) = (x" + sign + ")^(1/2)";
      x0 = -cRoot;
      y0 = Math.sqrt(cRoot);
    } else if (type === "pos") {
      const n = randInt(2,8);
      const a = randChoice([-2,-1,1,2]);
      const xNull = randChoice([-3,-2,-1,1,2,3]);
      const signX0 = xNull > 0 ? " ‚àí " + xNull : " + " + (-xNull);
      f2Expr = "g(x) = " + a + "¬∑(x" + signX0 + ")^" + n;
      x0 = xNull;
      y0 = a * Math.pow(-xNull, n);
    } else {
      const h = randChoice([-4,-3,-2,-1,1,2,3,4]);
      const k = randChoice([-2,-1,1,2]);
      const t = randChoice([-3,-2,-1,1,2,3]); // a = k*t
      const a = k * t;
      const signH = h > 0 ? " ‚àí " + h : " + " + (-h);
      const signK = k > 0 ? " + " + k : " ‚àí " + (-k);
      f2Expr = "g(x) = " + a + "/(x" + signH + ")" + signK;
      x0 = h - t;
      y0 = a/(-h) + k;
    }

    document.getElementById("l3Function2Display").textContent = f2Expr;
    level3Data.f2 = { y0: y0, x: x0 };

    // Eingaben & Ergebnis leeren
    ["l3f1_y","l3f1_x1","l3f1_x2","l3f2_y","l3f2_x"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });
    document.getElementById("level3Result").textContent = "";
  }

  document.getElementById("randomLevel3Btn").addEventListener("click", randomizeLevel3);

  document.getElementById("checkLevel3Btn").addEventListener("click", () => {
    const y1 = parseFloat(document.getElementById("l3f1_y").value);
    const x1 = parseFloat(document.getElementById("l3f1_x1").value);
    const x2 = parseFloat(document.getElementById("l3f1_x2").value);
    const y2 = parseFloat(document.getElementById("l3f2_y").value);
    const x3 = parseFloat(document.getElementById("l3f2_x").value);

    let correct = 0;

    if (near(y1, level3Data.f1.y0)) correct++;
    if (near(x1, level3Data.f1.x1)) correct++;
    if (near(x2, level3Data.f1.x2)) correct++;

    if (near(y2, level3Data.f2.y0)) correct++;
    if (near(x3, level3Data.f2.x)) correct++;

    const gained = correct; // 1 pro richtig
    updateScore(gained);

    const resultEl = document.getElementById("level3Result");
    resultEl.className = "result";

    if (correct === 5) {
      updateScore(1); // Bonuspunkt
      resultEl.classList.add("ok");
      resultEl.textContent =
        `Sehr gut! Alle Werte sind korrekt. +${gained + 1} Punkte (inkl. 1 Bonuspunkt)`;
    } else if (correct > 0) {
      resultEl.classList.add("info");
      resultEl.textContent =
        `Du hast ${correct} von 5 Werten richtig (+${gained} Punkte). √úberpr√ºfe noch einmal deine Rechnungen.`;
    } else {
      resultEl.classList.add("bad");
      resultEl.textContent =
        "Noch kein Wert korrekt erkannt. Tipp: Setze x = 0 f√ºr die y-Achse und l√∂se f(x) = 0 f√ºr die x-Achse.";
    }
  });

  // ---- LEVEL 4: Definitions- & Wertebereiche ----
  // NEU: F√ºr jede Funktion eigene Auswahloptionen (Labels) f√ºr D und W
  const l4Functions = [
    {
      expr: "f(x) = x¬≤ ‚àí 4",
      domainKey: "all",
      rangeKey: "y_ge_minus4",
      type: "quad_min",
      domainOptions: [
        { value: "all", label: "D = ‚Ñù" },
        { value: "x_ge_0", label: "D = { x | x ‚â• 0 }" },
        { value: "x_not_0", label: "D = ‚Ñù \\ {0}" }
      ],
      rangeOptions: [
        { value: "y_ge_minus4", label: "W = { y | y ‚â• ‚àí4 }" },
        { value: "all", label: "W = ‚Ñù" },
        { value: "y_ge_0", label: "W = { y | y ‚â• 0 }" }
      ]
    },
    {
      expr: "g(x) = 2x ‚àí 3",
      domainKey: "all",
      rangeKey: "all",
      type: "linear",
      domainOptions: [
        { value: "all", label: "D = ‚Ñù" },
        { value: "x_not_0", label: "D = ‚Ñù \\ {0}" },
        { value: "x_ge_0", label: "D = { x | x ‚â• 0 }" }
      ],
      rangeOptions: [
        { value: "all", label: "W = ‚Ñù" },
        { value: "y_ge_0", label: "W = { y | y ‚â• 0 }" },
        { value: "y_not_0", label: "W = ‚Ñù \\ {0}" }
      ]
    },
    {
      expr: "h(x) = x^(1/2)",
      domainKey: "x_ge_0",
      rangeKey: "y_ge_0",
      type: "root",
      domainOptions: [
        { value: "x_ge_0", label: "D = { x | x ‚â• 0 }" },
        { value: "all", label: "D = ‚Ñù" },
        { value: "x_not_0", label: "D = ‚Ñù \\ {0}" }
      ],
      rangeOptions: [
        { value: "y_ge_0", label: "W = { y | y ‚â• 0 }" },
        { value: "all", label: "W = ‚Ñù" },
        { value: "y_not_0", label: "W = ‚Ñù \\ {0}" }
      ]
    },
    {
      expr: "p(x) = (x ‚àí 2)^(1/2)",
      domainKey: "x_ge_2",
      rangeKey: "y_ge_0",
      type: "root_shift",
      domainOptions: [
        { value: "x_ge_2", label: "D = { x | x ‚â• 2 }" },
        { value: "x_ge_0", label: "D = { x | x ‚â• 0 }" },
        { value: "all", label: "D = ‚Ñù" }
      ],
      rangeOptions: [
        { value: "y_ge_0", label: "W = { y | y ‚â• 0 }" },
        { value: "all", label: "W = ‚Ñù" },
        { value: "y_ge_minus4", label: "W = { y | y ‚â• ‚àí4 }" }
      ]
    },
    {
      expr: "q(x) = 1/x",
      domainKey: "x_not_0",
      rangeKey: "y_not_0",
      type: "reciprocal",
      domainOptions: [
        { value: "x_not_0", label: "D = ‚Ñù \\ {0}" },
        { value: "all", label: "D = ‚Ñù" },
        { value: "x_ge_0", label: "D = { x | x ‚â• 0 }" }
      ],
      rangeOptions: [
        { value: "y_not_0", label: "W = ‚Ñù \\ {0}" },
        { value: "all", label: "W = ‚Ñù" },
        { value: "y_ge_0", label: "W = { y | y ‚â• 0 }" }
      ]
    },
    {
      expr: "r(x) = x^4 ‚àí 4",
      domainKey: "all",
      rangeKey: "y_ge_minus4",
      type: "even_power_shift",
      domainOptions: [
        { value: "all", label: "D = ‚Ñù" },
        { value: "x_ge_0", label: "D = { x | x ‚â• 0 }" },
        { value: "x_not_0", label: "D = ‚Ñù \\ {0}" }
      ],
      rangeOptions: [
        { value: "y_ge_minus4", label: "W = { y | y ‚â• ‚àí4 }" },
        { value: "all", label: "W = ‚Ñù" },
        { value: "y_ge_0", label: "W = { y | y ‚â• 0 }" }
      ]
    },
    {
      expr: "s(x) = x^6",
      domainKey: "all",
      rangeKey: "y_ge_0",
      type: "even_power",
      domainOptions: [
        { value: "all", label: "D = ‚Ñù" },
        { value: "x_ge_0", label: "D = { x | x ‚â• 0 }" },
        { value: "x_not_0", label: "D = ‚Ñù \\ {0}" }
      ],
      rangeOptions: [
        { value: "y_ge_0", label: "W = { y | y ‚â• 0 }" },
        { value: "all", label: "W = ‚Ñù" },
        { value: "y_not_0", label: "W = ‚Ñù \\ {0}" }
      ]
    },
    {
      expr: "t(x) = 1/x^3",
      domainKey: "x_not_0",
      rangeKey: "y_not_0",
      type: "reciprocal",
      domainOptions: [
        { value: "x_not_0", label: "D = ‚Ñù \\ {0}" },
        { value: "all", label: "D = ‚Ñù" },
        { value: "x_ge_0", label: "D = { x | x ‚â• 0 }" }
      ],
      rangeOptions: [
        { value: "y_not_0", label: "W = ‚Ñù \\ {0}" },
        { value: "all", label: "W = ‚Ñù" },
        { value: "y_ge_0", label: "W = { y | y ‚â• 0 }" }
      ]
    }
  ];

  let currentL4Index = null;
  let l4CorrectCount = 0;

  function pickRandomL4Index() {
    return Math.floor(Math.random() * (l4Functions.length));
  }

  // NEU: Hilfsfunktion, um Select-Optionen pro Funktion neu aufzubauen
  function rebuildSelectOptions(selectEl, optionsArray) {
    if (!selectEl) return;
    selectEl.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "‚Äì bitte w√§hlen ‚Äì";
    selectEl.appendChild(placeholder);

    optionsArray.forEach(opt => {
      const o = document.createElement("option");
      o.value = opt.value;
      o.textContent = opt.label;
      selectEl.appendChild(o);
    });

    selectEl.value = "";
    selectEl.selectedIndex = 0;
  }

  function showL4Function(idx) {
    const fn = l4Functions[idx];
    currentL4Index = idx;
    document.getElementById("l4FunctionDisplay").textContent = fn.expr;

    const domSel = document.getElementById("l4DomainSelect");
    const ranSel = document.getElementById("l4RangeSelect");

    // NEU: Auswahloptionen an die neue Funktion anpassen
    rebuildSelectOptions(domSel, fn.domainOptions);
    rebuildSelectOptions(ranSel, fn.rangeOptions);

    const resEl = document.getElementById("level4Result");
    if (resEl) {
      resEl.className = "result";
      resEl.textContent = "";
    }
  }

  document.getElementById("newL4FunctionBtn").addEventListener("click", () => {
    showL4Function(pickRandomL4Index());
  });

  function getFaustformel(type) {
    switch (type) {
      case "linear":
        return "Faustformel: Bei linearen Funktionen f(x) = m¬∑x + b gilt immer:\n" +
               "‚Ä¢ Definitionsmenge: alle reellen Zahlen (x darf beliebig sein).\n" +
               "‚Ä¢ Wertemenge: alle reellen Zahlen (f√ºr jeden y-Wert gibt es ein x).";
      case "quad_min":
      case "even_power_shift":
        return "Faustformel: Bei Parabeln/geraden Potenzen nach oben ge√∂ffnet (f(x) = x¬≤ + c oder x^4 ‚àí 4 usw.) gilt:\n" +
               "‚Ä¢ Definitionsmenge: alle reellen Zahlen (x darf beliebig sein).\n" +
               "‚Ä¢ Wertemenge: ab dem y-Wert des Tiefpunktes nach oben (z.B. y ‚â• ‚àí4).";
      case "even_power":
        return "Faustformel: Bei geraden Potenzen ohne Verschiebung (f(x) = x^n mit n gerade) gilt:\n" +
               "‚Ä¢ Definitionsmenge: alle reellen Zahlen.\n" +
               "‚Ä¢ Wertemenge: y ‚â• 0 (die Funktion ist nie negativ).";
      case "root":
      case "root_shift":
        return "Faustformel: Bei Wurzelfunktionen (z.B. f(x) = (x ‚àí a)^(1/2)) gilt:\n" +
               "‚Ä¢ Definitionsmenge: Inneres der Wurzel ‚â• 0 ‚Üí x ‚àí a ‚â• 0 ‚Üí x ‚â• a.\n" +
               "‚Ä¢ Wertemenge: y ‚â• 0, weil eine Quadratwurzel nie negativ ist (plus evtl. Verschiebung nach oben/unten).";
      case "reciprocal":
        return "Faustformel: Bei Funktionen mit 1/x^n (negativen Exponenten) gilt:\n" +
               "‚Ä¢ Definitionsmenge: Nenner ‚â† 0 ‚Üí x darf nicht 0 sein.\n" +
               "‚Ä¢ Wertemenge: y ‚â† 0, weil der Bruch nie genau 0 wird.";
      default:
        return "Faustformel:\n" +
               "‚Ä¢ Definitionsmenge: Alles, wo der Term √ºberhaupt berechnet werden kann (keine Division durch 0, keine negativen Zahlen unter der geraden Wurzel).\n" +
               "‚Ä¢ Wertemenge: Die y-Werte, die beim Einsetzen aller erlaubten x entstehen (oft am Graphen ablesbar).";
    }
  }

  document.getElementById("checkLevel4Btn").addEventListener("click", () => {
    const resultEl = document.getElementById("level4Result");
    resultEl.className = "result";

    if (currentL4Index === null) {
      resultEl.classList.add("info");
      resultEl.textContent = "Bitte zuerst eine Funktion mit ‚ÄûNeue Funktion‚Äú ausw√§hlen.";
      return;
    }

    const fn = l4Functions[currentL4Index];
    const dom = document.getElementById("l4DomainSelect").value;
    const ran = document.getElementById("l4RangeSelect").value;

    if (!dom || !ran) {
      resultEl.classList.add("info");
      resultEl.textContent = "Bitte sowohl Definitions- als auch Wertebereich ausw√§hlen.";
      return;
    }

    let gained = 0;
    let feedback = "";

    if (dom === fn.domainKey && ran === fn.rangeKey) {
      gained = 1;
      l4CorrectCount++;
      updateScore(gained);
      resultEl.classList.add("ok");
      feedback =
        `Korrekt! (+${gained} Punkt). Du hast bisher ${l4CorrectCount} richtige Paare in Level 4.`;
      if (l4CorrectCount >= 5) {
        feedback += " üéâ Maximalpunktzahl f√ºr dieses Level erreicht.";
      }
    } else {
      resultEl.classList.add("bad");
      feedback =
        "Leider nicht ganz korrekt. √úberlege: Wo ist die Funktion nicht definiert (z.B. Nenner = 0 oder negative Zahl unter der Wurzel)? Und welche y-Werte kann sie annehmen?";
    }

    const faust = getFaustformel(fn.type);
    resultEl.textContent = feedback + "\n\n" + faust;
  });

  // gleich beim Start eine Funktion anzeigen
  showL4Function(0);

  // ---------- GRAPH TAB (Canvas) ----------
  const graphCanvas = document.getElementById("graphCanvas");
  const ctx = graphCanvas.getContext("2d");
  const graphFunctionSelect = document.getElementById("graphFunctionSelect");
  const graphControlsContainer = document.getElementById("graphControls");
  const graphFormula = document.getElementById("graphFormula");

  const world = { xmin: -10, xmax: 10, ymin: -10, ymax: 10 };

  function worldToScreen(x, y) {
    const { xmin, xmax, ymin, ymax } = world;
    const width = graphCanvas.width;
    const height = graphCanvas.height;
    const sx = (x - xmin) / (xmax - xmin) * width;
    const sy = height - (y - ymin) / (ymax - ymin) * height;
    return { x: sx, y: sy };
  }

  function clearCanvas() {
    ctx.fillStyle = "#020617";
    ctx.fillRect(0, 0, graphCanvas.width, graphCanvas.height);
  }

  function drawAxes() {
    const { xmin, xmax, ymin, ymax } = world;
    ctx.save();
    ctx.strokeStyle = "rgba(148,163,184,0.8)";
    ctx.lineWidth = 1;

    // x-Achse (y=0)
    if (ymin < 0 && ymax > 0) {
      ctx.beginPath();
      const p1 = worldToScreen(xmin, 0);
      const p2 = worldToScreen(xmax, 0);
      ctx.moveTo(p1.x, p1.y);
      ctx.lineTo(p2.x, p2.y);
      ctx.stroke();
    }

    // y-Achse (x=0)
    if (xmin < 0 && xmax > 0) {
      ctx.beginPath();
      const p1 = worldToScreen(0, ymin);
      const p2 = worldToScreen(0, ymax);
      ctx.moveTo(p1.x, p1.y);
      ctx.lineTo(p2.x, p2.y);
      ctx.stroke();
    }

    // Ticks und Beschriftung
    ctx.fillStyle = "rgba(148,163,184,0.9)";
    ctx.font = "10px system-ui";
    const tickSize = 4;

    // x-Ticks
    if (ymin < 0 && ymax > 0) {
      for (let x = Math.ceil(xmin); x <= Math.floor(xmax); x++) {
        if (x === 0) continue;
        const p = worldToScreen(x, 0);
        ctx.beginPath();
        ctx.moveTo(p.x, p.y - tickSize);
        ctx.lineTo(p.x, p.y + tickSize);
        ctx.stroke();
        ctx.fillText(String(x), p.x - 3, p.y + 12);
      }
    }

    // y-Ticks
    if (xmin < 0 && xmax > 0) {
      for (let y = Math.ceil(ymin); y <= Math.floor(ymax); y++) {
        if (y === 0) continue;
        const p = worldToScreen(0, y);
        ctx.beginPath();
        ctx.moveTo(p.x - tickSize, p.y);
        ctx.lineTo(p.x + tickSize, p.y);
        ctx.stroke();
        ctx.fillText(String(y), p.x + 6, p.y + 3);
      }
    }

    // Achsenbeschriftung x und y
    if (ymin < 0 && ymax > 0) {
      const pRight = worldToScreen(xmax, 0);
      ctx.fillText("x", pRight.x - 10, pRight.y - 6);
    }
    if (xmin < 0 && xmax > 0) {
      const pTop = worldToScreen(0, ymax);
      ctx.fillText("y", pTop.x + 6, pTop.y + 10);
    }

    ctx.restore();
  }

  function drawFunction(f, domainCheck) {
    ctx.strokeStyle = "#60a5fa";
    ctx.lineWidth = 2;

    const steps = graphCanvas.width;
    let first = true;
    ctx.beginPath();

    for (let i = 0; i < steps; i++) {
      const t = i / (steps - 1);
      const x = world.xmin + t * (world.xmax - world.xmin);

      if (domainCheck && !domainCheck(x)) {
        first = true;
        continue;
      }

      let y = f(x);
      if (!isFinite(y)) {
        first = true;
        continue;
      }
      if (y < world.ymin - 1 || y > world.ymax + 1) {
        first = true;
        continue;
      }

      const p = worldToScreen(x, y);
      if (first) {
        ctx.moveTo(p.x, p.y);
        first = false;
      } else {
        ctx.lineTo(p.x, p.y);
      }
    }
    ctx.stroke();
  }

  function drawAsymptoteAndHole(h, k) {
    ctx.save();
    ctx.setLineDash([5, 5]);
    ctx.strokeStyle = "rgba(248,250,252,0.5)";
    ctx.lineWidth = 1;

    // vertikale Asymptote x = h
    if (h > world.xmin && h < world.xmax) {
      const p1 = worldToScreen(h, world.ymin);
      const p2 = worldToScreen(h, world.ymax);
      ctx.beginPath();
      ctx.moveTo(p1.x, p1.y);
      ctx.lineTo(p2.x, p2.y);
      ctx.stroke();
    }

    // horizontale Asymptote y = k
    if (k > world.ymin && k < world.ymax) {
      const p1 = worldToScreen(world.xmin, k);
      const p2 = worldToScreen(world.xmax, k);
      ctx.beginPath();
      ctx.moveTo(p1.x, p1.y);
      ctx.lineTo(p2.x, p2.y);
      ctx.stroke();
    }

    ctx.setLineDash([]);

    // ‚ÄûL√ºcke‚Äú am Punkt (h,k) als offener Kreis
    if (h > world.xmin && h < world.xmax && k > world.ymin && k < world.ymax) {
      const p = worldToScreen(h, k);
      ctx.beginPath();
      ctx.arc(p.x, p.y, 5, 0, 2 * Math.PI);
      ctx.strokeStyle = "rgba(248,250,252,0.8)";
      ctx.lineWidth = 1.5;
      ctx.stroke();
    }

    ctx.restore();
  }

  function createSlider(id, labelText, min, max, step, value) {
    const wrapper = document.createElement("div");
    wrapper.className = "slider-row";
    const label = document.createElement("label");
    label.textContent = `${labelText}: ${value}`;
    label.htmlFor = id;

    const input = document.createElement("input");
    input.type = "range";
    input.min = min;
    input.max = max;
    input.step = step;
    input.value = value;
    input.id = id;

    input.addEventListener("input", () => {
      label.textContent = `${labelText}: ${input.value}`;
      drawGraph();
    });

    wrapper.appendChild(label);
    wrapper.appendChild(input);
    return wrapper;
  }

  function createExponentSelect(id, value) {
    const wrapper = document.createElement("div");
    wrapper.className = "slider-row";
    const label = document.createElement("label");
    label.textContent = `Exponent n: ${value}`;
    label.htmlFor = id;

    const select = document.createElement("select");
    select.id = id;
    for (let n = 2; n <= 12; n++) {
      const opt = document.createElement("option");
      opt.value = n;
      opt.textContent = n;
      if (n === value) opt.selected = true;
      select.appendChild(opt);
    }

    select.addEventListener("change", () => {
      label.textContent = `Exponent n: ${select.value}`;
      drawGraph();
    });

    wrapper.appendChild(label);
    wrapper.appendChild(select);
    return wrapper;
  }

  function setGraphControls() {
    const type = graphFunctionSelect.value;
    graphControlsContainer.innerHTML = "";

    if (type === "linear") {
      graphFormula.textContent = "f(x) = m¬∑x + b";
      graphControlsContainer.appendChild(createSlider("m", "m (Steigung)", -5, 5, 0.1, 1));
      graphControlsContainer.appendChild(createSlider("b", "b (y-Verschiebung)", -5, 5, 0.1, 0));
    } else if (type === "pos") {
      graphFormula.textContent = "f(x) = a¬∑(x ‚àí h)‚Åø + k (n = 2,‚Ä¶,12)";
      graphControlsContainer.appendChild(createSlider("a", "a (Streckung/Spiegelung)", -3, 3, 0.1, 1));
      graphControlsContainer.appendChild(createSlider("h", "h (Verschiebung in x-Richtung)", -5, 5, 0.1, 0));
      graphControlsContainer.appendChild(createSlider("k", "k (Verschiebung in y-Richtung)", -5, 5, 0.1, 0));
      graphControlsContainer.appendChild(createExponentSelect("n", 2));
    } else if (type === "neg") {
      graphFormula.textContent = "f(x) = a / (x ‚àí h)‚Åø + k (n = 1,‚Ä¶,12)";
      graphControlsContainer.appendChild(createSlider("a", "a (Streckung/Spiegelung)", -5, 5, 0.1, 1));
      graphControlsContainer.appendChild(createSlider("h", "h (Verschiebung in x-Richtung)", -5, 5, 0.1, 0));
      graphControlsContainer.appendChild(createSlider("k", "k (Verschiebung in y-Richtung)", -5, 5, 0.1, 0));

      const wrapper = document.createElement("div");
      wrapper.className = "slider-row";
      const label = document.createElement("label");
      label.textContent = "Exponent n: 1";
      label.htmlFor = "nNeg";

      const select = document.createElement("select");
      select.id = "nNeg";
      for (let n = 1; n <= 12; n++) {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        select.appendChild(opt);
      }
      select.addEventListener("change", () => {
        label.textContent = "Exponent n: " + select.value;
        drawGraph();
      });
      wrapper.appendChild(label);
      wrapper.appendChild(select);
      graphControlsContainer.appendChild(wrapper);
    } else if (type === "root") {
      graphFormula.textContent = "f(x) = a¬∑(x ‚àí h)^(1/2) + k (Definitionsbereich: x ‚â• h)";
      graphControlsContainer.appendChild(createSlider("a", "a (Streckung/Spiegelung)", -3, 3, 0.1, 1));
      graphControlsContainer.appendChild(createSlider("h", "h (Verschiebung in x-Richtung)", -5, 5, 0.1, 0));
      graphControlsContainer.appendChild(createSlider("k", "k (Verschiebung in y-Richtung)", -5, 5, 0.1, 0));
    }

    drawGraph();
  }

  function getControlValue(id, defaultValue) {
    const el = document.getElementById(id);
    if (!el) return defaultValue;
    const v = parseFloat(el.value);
    return isNaN(v) ? defaultValue : v;
  }

  function drawGraph() {
    clearCanvas();
    drawAxes();

    const type = graphFunctionSelect.value;

    if (type === "linear") {
      const m = getControlValue("m", 1);
      const b = getControlValue("b", 0);
      const f = x => m * x + b;
      drawFunction(f, null);
    } else if (type === "pos") {
      const a = getControlValue("a", 1);
      const h = getControlValue("h", 0);
      const k = getControlValue("k", 0);
      const n = parseInt(document.getElementById("n").value, 10) || 2;
      const f = x => a * Math.pow(x - h, n) + k;
      drawFunction(f, null);
    } else if (type === "neg") {
      const a = getControlValue("a", 1);
      const h = getControlValue("h", 0);
      const k = getControlValue("k", 0);
      const n = parseInt(document.getElementById("nNeg").value, 10) || 1;
      const f = x => a / Math.pow(x - h, n) + k;
      const domainCheck = x => Math.abs(x - h) > 0.0001;
      drawFunction(f, domainCheck);
      drawAsymptoteAndHole(h, k);
    } else if (type === "root") {
      const a = getControlValue("a", 1);
      const h = getControlValue("h", 0);
      const k = getControlValue("k", 0);
      const f = x => a * Math.pow(x - h, 0.5) + k; // x^(1/2)
      const domainCheck = x => x >= h;
      drawFunction(f, domainCheck);
    }
  }

  graphFunctionSelect.addEventListener("change", setGraphControls);

  // Initiale Einstellungen
  setGraphControls();
</script>
</body>
</html>
